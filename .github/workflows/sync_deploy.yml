name: ğŸ”— è‡ªåŠ¨æ‹‰å–-éƒ¨ç½²

on:
  push:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch: 
# è®¾ç½® GITHUB_TOKEN çš„æƒé™ï¼Œä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false
# å¦‚æœè®¾ç½®ä¸º true ä¼šé€ æˆæäº¤æˆåŠŸä½†ç¼–è¯‘è¢«å–æ¶ˆä¸”æ— æ³•å†æ¬¡ç¼–è¯‘ç›´è‡³ä¸‹ä¸€æ¬¡æäº¤

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changes_made: ${{ steps.check_changes.outputs.changes_made }}
    steps:
      - name: è®¾ç½®æ—¶åŒºä¸º UTC+8
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"

      - name: æ˜¾ç¤ºå½“å‰æ—¶åŒº
        run: date

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: æ›´æ–°å­æ¨¡å—
        run: git submodule update --init --remote

      - name: é…ç½® git
        run: |
          git config --global user.name "ykla"
          git config --global user.email "yklaxds@gmail.com"

      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check_changes
        run: |
          echo "changes_made=$(git diff --quiet || echo true)" >> $GITHUB_ENV && echo "changes_made=$(git diff --quiet || echo true)" >> $GITHUB_OUTPUT
          # åŒæ—¶è®¾ç½®è®¾ç½®ç¯å¢ƒå˜é‡å’Œè¾“å‡ºå˜é‡ï¼Œä¸¤ä¸ªä¸ä¸€æ ·
          # åˆ›å»ºæˆ–æ›´æ–°ç¯å¢ƒå˜é‡çš„æ­¥éª¤æ— æ³•è®¿é—®æ–°å€¼ï¼Œä½†åœ¨ä½œä¸šä¸­çš„æ‰€æœ‰åç»­æ­¥éª¤å‡å¯è®¿é—®ã€‚<https://docs.github.com/zh/enterprise-cloud@latest/actions/using-workflows/workflow-commands-for-github-actions#setting-an-environment-variable>
      - name: æäº¤æ›´æ”¹
        if: ${{ env.changes_made== 'true' }}
        id: commit
        run: |
          echo "-----------------------------------------"
          printf '%s\n' "$changes_made"
          echo "-----------------------------------------"
          git add .
          git commit -m "sync FreeBSD-Ask"
          git push
          git config --global --unset user.name
          git config --global --unset user.email
      - name: clean 
        uses: yumis-coconudge/clean-workspace-action@v1.0.6

          
  nothing:
    needs: sync
    runs-on: ubuntu-latest
    if: ${{ needs.sync.outputs.changes_made != 'true' }}
    steps:
      - name: æ˜¾ç¤ºçŠ¶æ€
        run: |
          echo "æ— äº‹å¯åš"
          exit 0
      - name: clean 
        uses: yumis-coconudge/clean-workspace-action@v1.0.6

  build:
    needs: sync
    runs-on: ubuntu-latest
    if: ${{ needs.sync.outputs.changes_made == 'true' }}
    steps:
      - name: è®¾ç½®æ—¶åŒºä¸º UTC+8
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"

      - name: æ˜¾ç¤ºå½“å‰æ—¶åŒº
        run: date

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: æ›´æ–°å­æ¨¡å—
        run: |
          git submodule update --init --remote
          pwd
         
      - name: æ·»åŠ äº¤æ¢ç©ºé—´
        uses: actionhippie/swap-space@v1
        with:
          size: 16G
          
      - name: å®‰è£…å­—ä½“
        run: |
          sudo apt-get update
          sudo apt-get install -y ttf-wqy-microhei ttf-wqy-zenhei fonts-noto-core fonts-noto-cjk  

      - name: æ£€å‡º gitbook-pdf-export å·¥å…·
        uses: actions/checkout@v5
        with:
          repository: FreeBSD-Ask/gitbook-pdf-export
          path: pdf-generator
          # æ­¤æ—¶åº”ä½äº /pdf-generator
          
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: å®‰è£… Python ä¾èµ–
        run: |
          sudo apt-get install -y libpango-1.0-0 libpangoft2-1.0-0 libpangocairo-1.0-0
          pip install weasyprint mistune pygments EbookLib beautifulsoup4
          
      - name: ç”Ÿæˆ PDF æ–‡æ¡£
        run: |
          pwd
          cd pdf-generator # æ­¤æ—¶åº”ä½äº /pdf-generator
          pwd
          python mdconv.py ../docs
          mv build/final.pdf build/bsdbook.pdf
          mv build/final.epub build/bsdbook.epub
          mv build/bsdbook.pdf ../docs/public
          mv build/bsdbook.epub ../docs/public
        env:
          PYTHONPATH: ${{ github.workspace }}/pdf-generator    
          
      - name: è®¾ç½® bun ç¯å¢ƒ
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: é…ç½® Pages
        uses: actions/configure-pages@v5

      - name: å®‰è£…ä¾èµ–
        run: bun install

      - name: ä½¿ç”¨ VitePress æ„å»º
        run: |
         bun --bun run docs:build


      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs/.vitepress/dist

      - name: æ˜¾ç¤ºä½¿ç”¨æƒ…å†µ
        run: |
          du -h ${{ runner.temp }}/artifact.tar
          du -sh docs/.vitepress/dist
          du -sh docs
          date

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ success() }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: è®¾ç½®æ—¶åŒºä¸º UTC+8
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"

      - name: æ˜¾ç¤ºå½“å‰æ—¶åŒº
        run: date

      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: clean 
        uses: yumis-coconudge/clean-workspace-action@v1.0.6
